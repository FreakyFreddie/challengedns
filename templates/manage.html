{% extends "admin/base.html" %}
{% block stylesheets %}
<style>
    #record-list > tbody > tr{
        cursor: pointer;
    }
</style>
{% endblock %}
{% block content %}
    <div id="errordiv" class="text-center">
        {% for error in errors %}
            <div class="alert alert-danger alert-dismissable" role="alert">
              <span class="sr-only">Error:</span>
              {{ error }}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button>
            </div>
        {% endfor %}
    </div>
    <div class="row">
        <h1>vSphere VMs</h1>
        <table id="record-list" class="table table-striped">
            <thead>
                <tr>
                    <td width="10px"><b>#</b></td>
                    <td><b>Record</b></td>
                    <td><b>IP address</b></td>
                </tr>
            </thead>
            <tbody>
            {% for record in records %}
                <tr data-toggle="modal" data-target="#record-modal">
                    <td>{{ loop.index }}</td>
                    <td class="chalname">{{ record[0] }}</td>
                    <td class="ipaddress">{{ record[1] }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="modal fade" id="record-modal" role="dialog"  tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h3 id="recordname">DNS record</h3>
                </div>
                <div class="modal-body">
                    <input id="ipaddress" />
                </div>
                <div class="modal-footer">
                    <button id="saverecord" type="button" class="btn btn-default">Save changes</button>
                    <button id="deleterecord" type="button" class="btn btn-default">Delete</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="new-record-modal" role="dialog"  tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h3 id="recordname">New DNS record</h3>
                </div>
                <div class="modal-body">
                    <input id="newchalname" />
                    <input id="newipaddress" />
                </div>
                <div class="modal-footer">
                    <button id="createrecord" type="button" class="btn btn-default">Create record</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript">
        //If you want to add content dynamically and still need it to work, and also with more than one form, you can do this:
        $(document).ready(function() {
            // row was clicked
            clickable_table_rows();

            $("#newrecord").click(function(){
                $('#record-modal').modal({show:true});
            });

            $("#createrecord").click(function(){
                new_record($("#newchalname").val(),$("#newipaddress").val());


            });

            //refresh VMs every x milliseconds
            setInterval (refresh_records(), 60000);
        });

        function clickable_table_rows(){
            $('.table > tbody > tr').click(function(){
                var chalname = $(this).find(".chalname").text();
                var ipaddress = $(this).find(".ipaddress").text();

                $('#recordname').empty().append(chalname);
                $('#ipaddress').empty().append(ipaddress);

                $('#record-modal').modal({show:true});

                //remove previous click event handlers and add new ones
                $("#saverecord").off("click").click(function(){
                    update_record($("#recordname").text(), $("#ipaddress").val());

                    //close modal
                    $('#record-modal').modal({show:false});

                    //refresh
                    refresh_records();
                });

                $("#deleterecord").off("click").click(function(){
                    remove_record($("#chalname").val());

                    //close modal
                    $('#record-modal').modal({show:false});

                    //refresh
                    refresh_records();
                });
            });
        }


        function new_record(chalname, ipaddress) {
            $request = $.ajax({
                method: "POST",
                url: script_root + "/admin/challengedns/manage/record/new?r=" + new Date().getTime(),
                data: {nonce: "{{ nonce }}", "chalname": chalname, "ipaddress": ipaddress}
            });

            process_response($request);
        }

        function update_record(chalname, ipaddress){
            $request = $.ajax({
                method: "POST",
                url: script_root + "/admin/challengedns/manage/record/" + chalname + "/update?r=" + new Date().getTime(),
                data: {nonce: "{{ nonce }}", "ipaddress": ipaddress}
            });

            process_response($request);
        }

        function remove_record(chalname){
            $request = $.ajax({
                method: "POST",
                url: script_root + "/admin/challengedns/manage/record/" + chalname + "delete?r=" + new Date().getTime(),
                data: {nonce: "{{ nonce }}"}
            });

            process_response($request);
        }

        function process_response($request) {
            var html;

            $request.done(function(response) {
                if (response === "Success!") {
                    html = '<div class="alert alert-success alert-dismissable" role="alert">\n' +
                        '<span class="sr-only">Success:</span>\n' +
                        'The operation has been successfully completed.' +
                        '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                        '<span aria-hidden="true">×</span></button>\n' +
                        '</div>';
                }
                else {
                    html = '<div class="alert alert-danger alert-dismissable" role="alert">\n' +
                        '<span class="sr-only">Error:</span>\n' +
                        response +
                        '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                        '<span aria-hidden="true">×</span></button>\n' +
                        '</div>';
                }
            });

            $request.fail(function(){
                    html = '<div class="alert alert-danger alert-dismissable" role="alert">\n' +
                        '<span class="sr-only">Error:</span>\n' +
                        'The request could not be completed.' +
                        '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                        '<span aria-hidden="true">×</span></button>\n' +
                        '</div>';
            });

            $("#errordiv").append(html);

            //refresh
            refresh_records();
        }

        function refresh_records(){
            $request = $.ajax({
                method:"POST",
                url: script_root + "/admin/challengedns/manage/update?r=" + new Date().getTime(),
                data: {nonce: "{{ nonce }}"}
            });

            $request.done(function(response) {
                var new_records_html = build_table_body(JSON.parse(response));

                $("#record-list").children("tbody").empty().append(new_records_html);

                clickable_table_rows();
            });

            $request.fail(function(){
                    var html = '<div class="alert alert-danger alert-dismissable" role="alert">\n' +
                        '<span class="sr-only">Error:</span>\n' +
                        'The request could not be completed.' +
                        '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                        '<span aria-hidden="true">×</span></button>\n' +
                        '</div>';

                    $("#errordiv").append(html);
            });
        }

        function build_table_body(json_records){
            var html = '';

            for(var i = 0; i < json_records.length; i++)
            {
                html += '<tr data-toggle="modal" data-target="#record-modal"><td>' +
                    i +
                    '</td><td class="chalname">' +
                    json_records[i][0] +
                    '</td><td class="ipaddress">' +
                    json_records[i][1] +
                    '</td></tr>'
            }

            return html
        }

        function refresh_vms(){
            $request = $.ajax({
                method:"POST",
                url: script_root + "/admin/vspherevms/manage/update?r=" + new Date().getTime(),
                data: {nonce: "{{ nonce }}"}
            });

            $request.done(function(message){
                var new_vm_array = JSON.parse(message);

                //check if uuid already present in array
                for(var i = 0; i < new_vm_array.length; i++) {
                    var vm_already_present = false;

                    for(var j = 0; j < vms.length; j++) {
                        if(new_vm_array[i]["UUID"] === vms[j]["UUID"]){
                            if(new_vm_array[i]["State"] !== vms[j]["State"] || new_vm_array[i]["Ipaddress"] !== vms[j]["Ipaddress"]){
                                vms[j] = new_vm_array[i];
                                update_existing_vm(new_vm_array[i]);
                            }

                            vm_already_present = true;
                        }
                    }

                    if(vm_already_present === false){
                        vms.push(new_vm_array[i]);
                        add_new_vm(new_vm_array[i]);
                    }
                }
            });
        }

        function update_existing_vm(vm){
            var selector = "#" + vm["UUID"];
            $(selector).empty();
            fill_box(vm);
        }

        function add_new_vm(vm){
            // add vm to list and print new box
            // create new box
            $("#vm-list").append("<div class=\"btn btn-theme btn-outlined\" id=\"" + vm["UUID"] + "\">");
            fill_box(vm);
        }

        function fill_box(vm) {
            var nonce = "{{ nonce }}";

            var selector = "#" + vm["UUID"];
            var html = '<ul class="list-unstyled">\n' +
                '<li class="Name">' +
                vm["Name"] +
                '</li>\n' +
                '<li class="Ipaddress">' +
                vm["Ipaddress"] +
                '</li>\n' +
                '<li class="State"><span class="circle ';

            if (vm["State"] === "poweredOn") {
                html += "green";
            }
            else if (vm["State"] === "poweredOff") {
                html += "red";
            }
            else if (vm["State"] === "suspended") {
                html += "orange";
            }
            else {
                html += "gray";
            }

            html += '"></span>  ' +
                vm["State"] +
                '</li>\n' +
                '</ul>\n' +
                '<div class="vm-operations">';

            if (vm["State"] === "poweredOff") {
                html += '<form class="vm-control" action="' +
                    script_root +
                    '/admin/vspherevms/manage/vm/' +
                    vm["UUID"] +
                    '/poweron" method="POST">\n' +
                    '<input id="nonce" value="' +
                    nonce +
                    '" name="nonce" type="hidden" />\n' +
                    '<button class="play" title="Start the VM"><i class="fa fa-play"></i></button>\n' +
                    '</form>';
            }
            else if (vm["State"] === "poweredOn") {
                html += '<form class="vm-control" action="' +
                    script_root +
                    '/admin/vspherevms/manage/vm/' +
                    vm["UUID"] +
                    '/suspend" method="POST">\n' +
                    '<input id="nonce" value="' +
                    nonce +
                    '" name="nonce" type="hidden" />\n' +
                    '<button class="suspend" title="Suspend the VM"><i class="fa fa-pause"></i></button>\n' +
                    '</form>';

                if (vm["Vmwaretools"] === "guestToolsRunning") {
                    html = '<form class="vm-control" action="' +
                        script_root +
                        '/admin/vspherevms/manage/vm/' +
                        vm["UUID"] +
                        '/shutdown" method="POST">\n' +
                        '<input id="nonce" value="' +
                        nonce +
                        '" name="nonce" type="hidden" />\n' +
                        '<button class="shutdown" title="Shut down the VM"><i class="fa fa-stop"></i></button>\n' +
                        '</form>\n' +
                        '<form class="vm-control" action="' +
                        script_root +
                        '/admin/vspherevms/manage/vm/' +
                        vm["UUID"] +
                        '/restart" method="POST">\n' +
                        '<input id="nonce" value="' +
                        nonce +
                        '" name="nonce" type="hidden" />\n' +
                        '<button class="restart" title="Restart the VM"><i class="fa fa-refresh"></i></button>\n' +
                        '</form>';
                }
            }
            else if (vm["State"] === "suspended") {
                html += '<form class="vm-control" action="' +
                    script_root +
                    '/admin/vspherevms/manage/vm/' +
                    vm["UUID"] +
                    '/resume" method="POST">\n' +
                    '<input id="nonce" value="' +
                    nonce +
                    '" name="nonce" type="hidden" />\n' +
                    '<button class="play" title="Resume the VM"><i class="fa fa-play"></i></button>\n' +
                    '</form>';
            }
            else {
                html += '<p>No actions possible</p>';
            }

            html += '</div>';

            $(selector).append(html);
        }

        //NEWLY CREATED BUTTONS ALSO NEED TO BE CLICKABLE
    </script>
{% endblock %}


    